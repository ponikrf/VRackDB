VRack DB
========

VRackDB - Это **встраиваемая In Memory** база данных предназначенная для хранения временных рядов (графиков). 

Особенности: 
 - Имеет простой формат запросов
 - Всегда возвращает данные в виде графика. 
 - Очень простая в использовании
 - Очень экономична/очень быстрая
 - Агрегация и модификаторы данных
 - Хранит данные в памяти. При закрытии программы данные будут потеряны
 - Резервирует память метрики, последующее добавление данных метрики не увеличивает потребление памяти
 - Простой инструмент отслеживания данных и создания тревожных сообщений

**Важно** Проект переехал. Github более дружелюбен для публичных проектов соткрытым исходным кодом. 

Для **быстрого старта** рекомендуем сразу посетить [наш гайд](https://github.com/ponikrf/VRackDB/wiki/%D0%93%D0%B0%D0%B9%D0%B4) или узнать [как это работает](https://github.com/ponikrf/VRackDB/wiki/%D0%9A%D0%B0%D0%BA-%D1%8D%D1%82%D0%BE-%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0%D0%B5%D1%82)

Доступна [локальная версия гайда](/docs/RU-Guide.md)

Какую проблему решает эта база?
===============================

Не всегда очевидно, насколько на самом деле сложно работать с графиками, пока сам не попробуешь. Получая постоянно новые данные, можно попытаться решить проблему хранения с помощью массива. В таком случае возникает масса проблем - нелинейность данных, упращение данных, агрегация, получение данных с произвольного отрезка графика. 

Подробнее о решении проблем можно прочитать в [введении](https://github.com/ponikrf/VRackDB/wiki/%D0%92%D0%B2%D0%B5%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5)

Мотивация
=========

В некоторых ситуациях очень не хватает простой базы данных для хранения метрик с простым языком запросов. Для общего примера была взята база Carbon + Whisper и по ее аналогии была сделана очень простая in memort база данных. 

**Почему база данных in memory?** Для хранения метрик можно использовать много инструментов, которые оптимизированно хранят данные на диске. Такие варинты не подходят когда используется SD карта в качестве хранилища или нет возможности деплоя сложного продукта. Иногда нужно встроить базу данных в само приложение для отображения графиков, которые после закрытия приложения смысла уже не имеют. Такие приложения обычно предоставляют возможность оценить рациональность сохранения графика, и если человеку он нужен, график сохраняется в другом формате, а данные из памяти очищаются после закрытия приложения. 

Поддержка
==========
Проще всего поддержать меня или проект вы можете в с помощью [Donationalerts](https://donationalerts.com/r/imerzytip). В донате обязательно укажите проект который вы хотите поддержать и изменения, которые вам бы хотелось видеть, что бы улучшить его. Это позволит мне гарантированно тратить 1 час своего времени за каждые ~10$ доната. Каждый донат будет включен в следующую сборку этого проекта, а так же будет прочитан на моем личном стриме.

Даже если я давно не вносил изменения в проект, это не значит, что проект мертв. Можете писать на ponik_rf@mail.ru, я постараюсь отреагировать как можно быстрее.

Последнее обновление 2.1.0
--------------------------

В этом обновлении добавлен простой инструмент для отслеживания данных в базе и генерации тревожных сообщений.

 * Добавлен классс `Alerting` - для отслеживания данных и генерации тревожных сообщений
 * Добавлен классс `AlertQuery` - для определения настроек запроса
 * Добавлен класс `BasicCondition` - для опеределения правила создания тревожных сообщений
 * Добавлен абстрактный класс `AlertCondtition` 
 * Класс `MetricResult` добавлен метод `isAggregateFunc`
 * Класс `Interval` убрано лишний `console.log`
 * Добавлен алиас для класса `Database` 

Установка
---------

```
# npm install -s vrack-db
```

Использования
-------------

[Simrrdb](https://gitlab.com/ponik_rf/simrrdb) - Пример проекта, который использует эту базу для временного хранения метрик и отображения их в Grafana

Рекомендуется ознакомиться с [официальным гайдом](https://github.com/ponikrf/VRackDB/wiki/%D0%93%D0%B0%D0%B9%D0%B4) или узнать [как это работает](https://github.com/ponikrf/VRackDB/wiki/%D0%9A%D0%B0%D0%BA-%D1%8D%D1%82%D0%BE-%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0%D0%B5%D1%82)

Ниже приведены краткие примеры и описания использования `Database`.

### Схемы 

База данных поддерживает разные схемы хранения метрик. Формат схем похож на формат Carbon + Whisper.

Добавление новой схемы:

```ts
import { Database } from "vrack-db";
const DB = new Database()

DB.scheme('test', 'test.name', '5s:10m, 1m:2h')
```

В примере выше мы создали схему `test`, для которой указали паттерн `test.name` и указали точность и длительность хранения метрик.

Разберем по порядку:

 - `test` - Название схемы
 - `test.name` -  Все метрики с именем `test.name.*` будут попадать в группу test.
 - `5s:10m, 1m:2h` - Указания точности и размера периода хранения метрики. В данном случае хранение с точностью 5 секунд общим периодом 10 минут, с точностью 1 минута период хранения 2 часа.

### Запись метрики в базу

```ts
DB.write("test.name.metricid", 1234.5678)
```

 - `test.name` - Название метрики, указывается так же, как и паттерны, маленкими буквами, актеты разделены точкам.
 - `1234.5678` - **Значение для метрики имеет тип float(32bit)**.

**Не рекомендуется делать длинные названия для метрик. Учитывайте, что название для метрики так же занимается пространство в памяти.** Например, если название метрики занимает 10 символов (10 байт) то на 1024 метрики уйдет 10кБ памяти (фактически больше).

Указание времени:

```ts
DB.write("test.name.metricid", 1234.5678, 123456789)
```

По умолчанию в качестве параметра времени передается значение `0`. Если значение `0`, то текущее время будет установлено в `now`. 
По этой причине, если вы используете абстрактные значения для указания времени, они должны начинаться со значения > 0.

Указание модификатора значения:

```ts
DB.write("test.name.metricid", 1234.5678, 0, 'sum')
```

### Чтение записей

```ts
const res = DB.read("test.name.metricid",'now-1h:now', '5s')
console.table(res.rows)
```
- `test.name` - Название записанной метрики
- `now-1h:now` - Период получения метрики
- `5s` - Точность, с какой сформировать ответ

Для функций чтений доступна **возможность агрегации данных** - см. [официальный гайд](https://github.com/ponikrf/VRackDB/wiki/%D0%93%D0%B0%D0%B9%D0%B4)

----

**Пожалуйста, учитывайте, что все вычисления в базе данных производятся в секундах**

----

Так же можно использовать `readCustomRange` для получения данных за произвольный период.

```ts
const dbRes = DB.readCustomRange('test.name.metricid', start, end, `5s`)
```

Вы можете использовать `read` и `readCustomRange` класса `Database` для получения конкретного количества метрик независимо от периода.

Например:
```ts
 // Вернет максимум 100 метрик на этот период
 const dbRes = DB.readCustomRange('target', start, end, 100)
```

Пример для общего практического понимания работы базы данных:

```ts
import { Database } from "vrack-db";

const DB = new Database()

DB.scheme('test', 'test.name.metricid', '5s:10m, 1m:2h, 15m:1d')

setInterval(()=>{
    DB.write("test.name.metricid", process.memoryUsage().heapTotal /1024 / 1024)
}, 1000)

setInterval(()=>{
    const res = DB.read("test.name.metricid",'now-1h:now', '5s')
    console.table(res.rows)
}, 5000)
```

-------

Использование класса `Database` это самый простой и правильный способ использования базы данных. 

-------


Отслеживание данных
-------------------

В Версии 2.1.0 добавлен небольшой инструмент для отслеживания данных. (подробнее смотрите в гайде)

Инициализация:

```ts
const AT = new Alerting(DB)
```

Запрос для данных определяется с помощью класса `AlertQuery`:

```ts
// getting interval, data interval, period, func
const aQuery = new AlertQuery('5s', '1s', 'now-15s:now', 'avg')
```
Для определения границ используется класс `BasicCondition`:

```ts
// level, condition type, params
const aConfig = new BasicCondition('danger',"outRange",[-5,5])
```

Необходимо начать отслеживать нужну метрику с необходимыми параметрами:

```ts
// metric path, query, config, id, additional
AT.watch('test.name.2',aQuery, aConfig, '', {})
```

Что бы получать сообщения, когда значение нарушит правило, можно подписаться на получение сообщения:

```ts
AT.addListener((alert) => { console.log(alert) })
```

В случае нарушения правила, вы будете получать сообщение типа:

```ts
{
  id: '24cf92b9066b5',
  value: 7.50190642674764,
  status: 'updated',
  count: 36,
  timestamp: 1702377145560,
  condition: {
    level: 'danger',
    id: '6633a39c10328',
    type: 'outRange',
    params: [ -5, 5 ]
  },
  areas: [ [ null, -5 ], [ 5, null ] ],
  threshholds: [ -5, 5 ],
  additional: {}
}
```